<!-- tournament-detail.component.html -->
<div class="crear-torneo-container">
  <!-- HEADER -->
  <header class="header">
    <div class="header__content">
      <button class="btn-volver" (click)="goBack()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
        Volver
      </button>
      <h1 class="page-title">MI TORNEO - {{ tournament?.nombre || 'CARGANDO...' }}</h1>
      <span class="status-badge" [ngClass]="getStatusBadge().class" *ngIf="tournament">
        {{ getStatusBadge().text }}
      </span>
    </div>
  </header>

  <!-- LOADING -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando torneo...</p>
  </div>

  <!-- ERROR -->
  <div *ngIf="error && !loading" class="error-alert">
    <h2>⚠️ Error</h2>
    <p>{{ error }}</p>
    <button (click)="goBack()" class="btn-back">Volver a Mis Torneos</button>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="content" *ngIf="!loading && !error && tournament">
    <!-- ALERTAS -->
    <div class="alert alert-warning" *ngIf="getValidationMessage()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
      </svg>
      {{ getValidationMessage() }}
    </div>

    <div class="grid">
      <!-- CONFIGURACIÓN -->
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">Configuración</h2>
          <button class="btn-icon btn-edit" (click)="abrirModalConfig()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
          </button>
        </div>

        <div class="card-body">
          <div class="config-resumen">
            <div class="config-item">
              <span class="config-label">Nombre:</span>
              <span class="config-value">{{ tournament.nombre }}</span>
            </div>
            <div class="config-item">
              <span class="config-label">Modalidad:</span>
              <span class="config-value">{{ tournament.modalidad }}</span>
            </div>
            <div class="config-item">
              <span class="config-label">Vueltas:</span>
              <span class="config-value">{{ tournament.vueltas }}</span>
            </div>
            <div class="config-item">
              <span class="config-label">Playoffs:</span>
              <span class="config-value">{{ tournament.cupos_playoffs }} equipos</span>
            </div>
            <div class="config-item">
              <span class="config-label">Horario:</span>
              <span class="config-value">{{ tournament.hora_ini }} - {{ tournament.hora_fin }}</span>
            </div>
          </div>

          <!-- Botón de Canchas -->
          <button class="btn btn-secondary mt-3 btn-block" (click)="abrirModalCanchas()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
            </svg>
            Canchas ({{ canchas.length }})
          </button>
        </div>
      </section>

      <!-- ÁRBITROS -->
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">Árbitros</h2>
          <button class="btn-icon btn-add" (click)="abrirModalArbitro()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
          </button>
        </div>

        <div class="card-body">
          <div class="list">
            <div class="list-item" *ngFor="let arbitro of arbitros; let i = index">
              <svg class="list-item-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
              <span class="list-item-text">{{ arbitro.nombre }}</span>
            </div>

            <div class="empty-state" *ngIf="arbitros.length === 0">
              <p>No hay árbitros agregados</p>
            </div>
          </div>
        </div>
      </section>

      <!-- EQUIPOS (ocupa todo el ancho) -->
      <section class="card card-wide">
        <div class="card-header">
          <h2 class="card-title">Equipos</h2>
          <span class="badge-count">{{ equipos.length }} / {{ getMinimumTeams() }} mínimo</span>
          <button class="btn-icon btn-add" (click)="abrirModalEquipo()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
          </button>
        </div>

        <div class="card-body">
          <div class="list">
            <div class="list-item" *ngFor="let equipo of equipos; let i = index">
              <div class="equipo-logo">
                <img *ngIf="equipo.logo_url" [src]="equipo.logo_url" [alt]="equipo.nombre">
                <span *ngIf="!equipo.logo_url">{{ equipo.nombre.charAt(0) }}</span>
              </div>
              <span class="list-item-text">
                {{ equipo.nombre }}
                <small class="jugadores-count">{{ getJugadoresCount(equipo) }} jugadores</small>
              </span>
              <div class="list-item-actions">
                <button class="btn-icon-small" (click)="editarEquipo(i)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                  </svg>
                </button>
                <button class="btn-icon-small btn-delete" (click)="eliminarEquipo(i, equipo.id_equipo)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                  </svg>
                </button>
              </div>
            </div>

            <div class="empty-state" *ngIf="equipos.length === 0">
              <p>No hay equipos agregados</p>
              <small>Agrega al menos {{ getMinimumTeams() }} equipos para poder generar el calendario</small>
            </div>
          </div>
        </div>
      </section>

      <!-- CALENDARIO (ocupa todo el ancho) -->
      <section class="card card-wide">
        <div class="card-header">
          <h2 class="card-title">Calendario del Torneo</h2>
          <div class="card-header-actions">
            <button
              class="btn-icon btn-calendar"
              *ngIf="calendarGenerated"
              (click)="abrirModalCalendario()"
              title="Ver calendario completo"
            >
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
              </svg>
            </button>
            <button
              class="btn-icon btn-regenerate"
              *ngIf="calendarGenerated"
              (click)="regenerateCalendar()"
              title="Regenerar calendario"
            >
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- No hay suficientes equipos -->
          <div *ngIf="equipos.length < getMinimumTeams()" class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.3;">
              <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z"/>
            </svg>
            <p>Calendario no disponible</p>
            <small>Agrega al menos {{ getMinimumTeams() }} equipos</small>
          </div>

          <!-- Listo para generar -->
          <div *ngIf="equipos.length >= getMinimumTeams() && !calendarGenerated" class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="color: #FF7F00;">
              <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z"/>
            </svg>
            <p>¿Listo para generar el calendario?</p>
            <button class="btn btn-primary mt-2" (click)="generateCalendar()" [disabled]="generatingCalendar">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" *ngIf="!generatingCalendar">
                <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 1.99 2H19c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z"/>
              </svg>
              <span *ngIf="generatingCalendar">Generando...</span>
              <span *ngIf="!generatingCalendar">Generar Calendario</span>
            </button>
          </div>

          <!-- Vista previa del calendario -->
          <div *ngIf="calendarGenerated && currentMonthPreview" class="calendar-preview">
            <!-- Header con navegación del mes -->
            <div class="calendar-preview-header">
              <button class="btn-nav-small" (click)="previousMonth()" [disabled]="loadingPreview">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
              </button>
              <h3 class="calendar-preview-title">{{ currentMonthPreview.nombre_mes }} {{ currentMonthPreview.anio }}</h3>
              <button class="btn-nav-small" (click)="nextMonth()" [disabled]="loadingPreview">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
              </button>
            </div>

            <!-- Estadísticas del mes -->
            <div class="calendar-stats-mini">
              <div class="stat-mini">
                <span class="stat-mini-value">{{ currentMonthPreview.total_partidos }}</span>
                <span class="stat-mini-label">Total</span>
              </div>
              <div class="stat-mini">
                <span class="stat-mini-value">{{ currentMonthPreview.partidos_programados }}</span>
                <span class="stat-mini-label">Programados</span>
              </div>
              <div class="stat-mini">
                <span class="stat-mini-value">{{ currentMonthPreview.partidos_jugados }}</span>
                <span class="stat-mini-label">Jugados</span>
              </div>
            </div>

            <!-- Mini calendario -->
            <div class="mini-calendar">
              <div class="mini-weekdays">
                <div class="mini-weekday">D</div>
                <div class="mini-weekday">L</div>
                <div class="mini-weekday">M</div>
                <div class="mini-weekday">X</div>
                <div class="mini-weekday">J</div>
                <div class="mini-weekday">V</div>
                <div class="mini-weekday">S</div>
              </div>
              <div class="mini-weeks">
                <div *ngFor="let semana of currentMonthPreview.semanas" class="mini-week">
                  <div
                    *ngFor="let dia of semana"
                    class="mini-day"
                    [class.other-month]="!dia.es_mes_actual"
                    [class.has-matches]="dia.tiene_partidos"
                  >
                    <span class="mini-day-number">{{ dia.dia }}</span>
                    <span class="mini-day-indicator" *ngIf="dia.tiene_partidos">
                      {{ dia.partidos.length }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botón para ver calendario completo -->
            <button class="btn btn-secondary btn-block mt-3" (click)="abrirModalCalendario()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
              </svg>
              Ver Calendario Completo
            </button>
          </div>

          <!-- Loading de vista previa -->
          <div *ngIf="calendarGenerated && !currentMonthPreview && loadingPreview" class="loading-preview">
            <div class="spinner-small"></div>
            <p>Cargando calendario...</p>
          </div>
        </div>
      </section>
    </div>

    <!-- BOTÓN DE INICIO -->
    <div class="action-bar" *ngIf="tournamentStatus === 'configurando'">
      <button 
        class="btn btn-lg btn-success"
        (click)="startTournament()"
        [disabled]="!canStartTournament()"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7z"/>
        </svg>
        Iniciar Torneo
      </button>
    </div>
  </main>
</div>

<!-- ========================================
     MODALES
     ======================================== -->

<!-- Modal de Configuración -->
<app-config-modal
  [isOpen]="modalConfigAbierto"
  [tournament]="tournament"
  (closeModal)="cerrarModalConfig()"
  (saveTournament)="actualizarConfiguracion($event)"
></app-config-modal>

<!-- Modal de Canchas -->
<app-court-modal
  [isOpen]="modalCanchaAbierto"
  [tournamentId]="tournamentId"
  [canchas]="canchas"
  (closeModal)="cerrarModalCanchas()"
  (canchasUpdated)="onCanchasUpdated()"
></app-court-modal>

<!-- Modal de Equipos -->
<app-team-modal
  [isOpen]="modalEquipoAbierto"
  [tournamentId]="tournamentId"
  [equipo]="equipoEditando"
  (closeModal)="cerrarModalEquipo()"
  (equipoUpdated)="onEquipoUpdated()"
></app-team-modal>

<!-- Modal de Árbitros -->
<app-referee-modal
  [isOpen]="modalArbitroAbierto"
  [tournamentId]="tournamentId"
  (closeModal)="cerrarModalArbitro()"
  (refereesUpdated)="onArbitrosUpdated()"
></app-referee-modal>

<!-- Modal de Calendario -->
<app-calendar-modal
  [isOpen]="modalCalendarioAbierto"
  [tournamentId]="tournamentId"
  (closeModal)="cerrarModalCalendario()"
></app-calendar-modal>
