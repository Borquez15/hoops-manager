<div class="match-live-container">
  <!-- Loading -->
  <div class="loading" *ngIf="loading">
    <div class="spinner"></div>
    <p>Cargando partido...</p>
  </div>

  <!-- Error -->
  <div class="error" *ngIf="error && !loading">
    <h2>‚ö†Ô∏è Error</h2>
    <p>{{ error }}</p>
    <button class="btn-back" (click)="goBack()">Volver</button>
  </div>

  <!-- SELECCI√ìN DE QUINTETO INICIAL -->
  <div class="quinteto-selector" *ngIf="seleccionandoQuinteto && !loading && partido">
    <div class="quinteto-header">
      <button class="btn-back-small" (click)="goBack()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
      </button>
      <h1>üìã SELECCIONAR QUINTETO INICIAL</h1>
    </div>

    <div class="quinteto-content">
      <div class="equipo-quinteto-card">
        <div class="equipo-header">
          <div class="equipo-logo-large">
            <img *ngIf="equipoSeleccionandoData?.logo_url" [src]="equipoSeleccionandoData?.logo_url">
            <span *ngIf="!equipoSeleccionandoData?.logo_url">
              {{ equipoSeleccionandoData?.nombre?.charAt(0) }}
            </span>
          </div>
          <h2>{{ equipoSeleccionandoData?.nombre }}</h2>
          <p class="subtitulo">Selecciona 5 jugadores iniciales</p>
        </div>

        <div class="contador-seleccion">
          <span class="seleccionados">{{ quintetoTemporal.length }}</span>
          <span class="separador">/</span>
          <span class="total">5</span>
          <small>jugadores seleccionados</small>
        </div>

        <div class="jugadores-grid">
          <div class="jugador-card"
               *ngFor="let jugador of equipoSeleccionandoData?.jugadores"
               [class.selected]="isJugadorSeleccionado(jugador)"
               (click)="toggleJugadorQuinteto(jugador)">
            <div class="jugador-numero">{{ jugador.dorsal }}</div>
            <div class="jugador-info">
              <h4>{{ jugador.nombres }} {{ jugador.ap_p }}</h4>
              <small>{{ jugador.ap_m || '' }}</small>
            </div>
            <div class="check-icon" *ngIf="isJugadorSeleccionado(jugador)">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="quinteto-actions">
          <button class="btn btn-lg btn-primary"
                  *ngIf="equipoSeleccionando === 'LOCAL'"
                  [disabled]="quintetoTemporal.length !== 5"
                  (click)="confirmarQuintetoLocal()">
            Confirmar Quinteto Local
          </button>
          
          <button class="btn btn-lg btn-primary"
                  *ngIf="equipoSeleccionando === 'VISITANTE'"
                  [disabled]="quintetoTemporal.length !== 5"
                  (click)="confirmarQuintetoVisitante()">
            Confirmar Quinteto Visitante e Iniciar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLERO EN VIVO -->
  <div class="live-board" *ngIf="!seleccionandoQuinteto && !loading && partido">
    
    <!-- Header Superior -->
    <div class="match-header-compact">
      <button class="btn-back-icon" (click)="goBack()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
      </button>
      
      <div class="match-title">
        <h2>{{ partido.equipo_local.nombre }} <span class="vs">VS</span> {{ partido.equipo_visitante.nombre }}</h2>
      </div>

      <div class="match-indicators">
        <span class="live-badge">üî¥ EN VIVO</span>
        <span class="periodo-badge">{{ getNombrePeriodo() }}</span>
      </div>
    </div>

    <!-- Layout Principal: 3 Columnas -->
    <div class="main-board">
      
      <!-- ========================================
           PANEL IZQUIERDO: EQUIPO LOCAL
           ======================================== -->
      <div class="team-panel team-local">
        <div class="team-panel-header">
          <h3>{{ partido.equipo_local.nombre }}</h3>
          
          <!-- Botones de Puntos -->
          <div class="team-actions">
            <button class="btn-team-action btn-add" (click)="abrirModalPuntosSumar('LOCAL')" title="Sumar puntos">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
            </button>
            <button class="btn-team-action btn-subtract" (click)="abrirModalPuntosRestar('LOCAL')" title="Restar puntos">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13H5v-2h14v2z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Timeouts -->
        <div class="timeouts-section">
          <span class="timeouts-label">Timeouts:</span>
          <div class="timeouts-dots">
            <div class="timeout-dot" [class.active]="i < partido.equipo_local.timeouts" 
                 *ngFor="let i of [0,1,2]"
                 (click)="usarTimeout('LOCAL')"></div>
          </div>
        </div>

        <div class="jugadores-list">
          <div class="jugador-item"
               *ngFor="let jugador of partido.equipo_local.quinteto"
               [class.encancha]="jugador.enCancha"
               [class.expulsado]="jugador.faltas >= 5">
            
            <!-- # N√∫mero -->
            <div class="jugador-numero-mini">{{ jugador.dorsal }}</div>
            
            <!-- Nombre -->
            <div class="jugador-nombre-mini">
              <span>{{ jugador.nombres }} {{ jugador.ap_p }}</span>
            </div>
            
            <!-- 5 C√≠rculos de Faltas -->
            <div class="jugador-faltas-mini" (click)="abrirModalFaltas('LOCAL', jugador)">
              <div class="falta-dot" 
                   [class.active]="i < jugador.faltas"
                   [class.expulsion]="i === 4 && jugador.faltas >= 5"
                   *ngFor="let i of [0,1,2,3,4]"></div>
            </div>
            
            <!-- Puntos -->
            <div class="jugador-puntos-mini">{{ jugador.puntos }}</div>
          </div>
        </div>

        <button class="btn-cambio-compact" (click)="abrirModalCambio('LOCAL')">
          üîÑ Cambio
        </button>
      </div>

      <!-- ========================================
           PANEL CENTRAL: MARCADOR Y TIMER
           ======================================== -->
      <div class="center-panel">
        
        <!-- Marcador Principal -->
        <div class="scoreboard-large">
          <!-- Score Local -->
          <div class="score-team">
            <div class="score-value">{{ partido.equipo_local.puntos }}</div>
            <div class="score-label">LOCAL</div>
          </div>

          <!-- Divisor Central -->
          <div class="score-divider">
            <!-- Faltas Local -->
            <div class="faltas-equipo">
              <div class="falta-label">Faltas</div>
              <div class="falta-count">{{ partido.equipo_local.faltas }}</div>
            </div>
            
            <!-- Per√≠odo -->
            <div class="periodo-central">
              <div class="periodo-number">{{ partido.periodo_actual }}</div>
              <div class="periodo-label">{{ partido.en_overtime ? 'OT' : 'Per√≠odo' }}</div>
            </div>

            <!-- Faltas Visitante -->
            <div class="faltas-equipo">
              <div class="falta-label">Faltas</div>
              <div class="falta-count">{{ partido.equipo_visitante.faltas }}</div>
            </div>
          </div>

          <!-- Score Visitante -->
          <div class="score-team">
            <div class="score-value">{{ partido.equipo_visitante.puntos }}</div>
            <div class="score-label">VISITANTE</div>
          </div>
        </div>

        <!-- Temporizador -->
        <div class="timer-section-large">
          <div class="timer-display" (click)="abrirModalEditarTiempo()">
            {{ formatearTiempo(tiempoTranscurrido) }}
          </div>
          
          <!-- Controles: - | PAUSE/PLAY | + -->
          <div class="timer-controls-large">
            <!-- Bot√≥n - -->
            <button class="btn-timer-ctrl" (click)="restarTiempo()">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13H5v-2h14v2z"/>
              </svg>
            </button>

            <!-- Bot√≥n PLAY -->
            <button class="btn-timer-ctrl btn-play" (click)="startTimer()" *ngIf="!timerActivo">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </button>

            <!-- Bot√≥n PAUSE -->
            <button class="btn-timer-ctrl btn-pause" (click)="pauseTimer()" *ngIf="timerActivo">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
              </svg>
            </button>

            <!-- Bot√≥n + -->
            <button class="btn-timer-ctrl" (click)="agregarTiempo()">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Acciones R√°pidas -->
        <div class="quick-actions">
          <button class="btn-quick" (click)="resetTimer()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
            </svg>
            Reiniciar
          </button>
          
          <button class="btn-quick btn-next-period" (click)="siguientePeriodo()">
            Siguiente Per√≠odo ‚ûî
          </button>
        </div>

        <!-- Bot√≥n Finalizar -->
        <button class="btn-finalizar-large" (click)="finalizarPartido()">
          üèÅ Finalizar Partido
        </button>
      </div>

      <!-- ========================================
           PANEL DERECHO: EQUIPO VISITANTE
           ======================================== -->
      <div class="team-panel team-visitante">
        <div class="team-panel-header">
          <h3>{{ partido.equipo_visitante.nombre }}</h3>
          
          <!-- Botones de Puntos -->
          <div class="team-actions">
            <button class="btn-team-action btn-add" (click)="abrirModalPuntosSumar('VISITANTE')" title="Sumar puntos">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
            </button>
            <button class="btn-team-action btn-subtract" (click)="abrirModalPuntosRestar('VISITANTE')" title="Restar puntos">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13H5v-2h14v2z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Timeouts -->
        <div class="timeouts-section">
          <span class="timeouts-label">Timeouts:</span>
          <div class="timeouts-dots">
            <div class="timeout-dot" [class.active]="i < partido.equipo_visitante.timeouts" 
                 *ngFor="let i of [0,1,2]"
                 (click)="usarTimeout('VISITANTE')"></div>
          </div>
        </div>

        <div class="jugadores-list">
          <div class="jugador-item"
               *ngFor="let jugador of partido.equipo_visitante.quinteto"
               [class.encancha]="jugador.enCancha"
               [class.expulsado]="jugador.faltas >= 5">
            
            <!-- Puntos -->
            <div class="jugador-puntos-mini">{{ jugador.puntos }}</div>
            
            <!-- 5 C√≠rculos de Faltas -->
            <div class="jugador-faltas-mini" (click)="abrirModalFaltas('VISITANTE', jugador)">
              <div class="falta-dot" 
                   [class.active]="i < jugador.faltas"
                   [class.expulsion]="i === 4 && jugador.faltas >= 5"
                   *ngFor="let i of [0,1,2,3,4]"></div>
            </div>
            
            <!-- Nombre -->
            <div class="jugador-nombre-mini">
              <span>{{ jugador.nombres }} {{ jugador.ap_p }}</span>
            </div>
            
            <!-- # N√∫mero -->
            <div class="jugador-numero-mini">{{ jugador.dorsal }}</div>
          </div>
        </div>

        <button class="btn-cambio-compact" (click)="abrirModalCambio('VISITANTE')">
          üîÑ Cambio
        </button>
      </div>

    </div>
  </div>
</div>

<!-- ========================================
     MODALES
     ======================================== -->

<!-- MODAL DE CAMBIO -->
<div class="modal-overlay" *ngIf="modalCambioAbierto" (click)="cerrarModalCambio()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üîÑ Realizar Cambio</h2>
      <button class="btn-close" (click)="cerrarModalCambio()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="cambio-section">
        <h3>Sale de la cancha:</h3>
        <div class="jugadores-cambio">
          <div class="jugador-cambio-card"
               *ngFor="let jugador of equipoCambio === 'LOCAL' ? (partido?.equipo_local?.quinteto || []) : (partido?.equipo_visitante?.quinteto || [])"
               [class.selected]="jugadorSaliente?.id_jugador === jugador.id_jugador"
               (click)="seleccionarJugadorSaliente(jugador)">
            <div class="jugador-numero-cambio">{{ jugador.dorsal }}</div>
            <div class="jugador-nombre-cambio">
              {{ jugador.nombres }} {{ jugador.ap_p }}
            </div>
          </div>
        </div>
      </div>

      <div class="cambio-arrow">‚Üì</div>

      <div class="cambio-section">
        <h3>Entra a la cancha:</h3>
        <div class="jugadores-cambio">
          <div class="jugador-cambio-card"
               *ngFor="let jugador of equipoCambio === 'LOCAL' ? (partido?.equipo_local?.banco || []) : (partido?.equipo_visitante?.banco || [])"
               [class.selected]="jugadorEntrante?.id_jugador === jugador.id_jugador"
               [class.disabled]="jugador.faltas >= 5"
               (click)="jugador.faltas < 5 && seleccionarJugadorEntrante(jugador)">
            <div class="jugador-numero-cambio">{{ jugador.dorsal }}</div>
            <div class="jugador-nombre-cambio">
              {{ jugador.nombres }} {{ jugador.ap_p }}
              <span *ngIf="jugador.faltas >= 5" class="expulsado-label">EXPULSADO</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalCambio()">Cancelar</button>
      <button class="btn btn-primary" 
              [disabled]="!jugadorSaliente || !jugadorEntrante"
              (click)="confirmarCambio()">
        Confirmar Cambio
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE PUNTOS - NUEVO DISE√ëO -->
<div class="modal-overlay" *ngIf="modalPuntosAbierto" (click)="cerrarModalPuntos()">
  <div class="modal-content-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ accionPuntos === 'SUMAR' ? '‚ûï Sumar Puntos' : '‚ûñ Restar Puntos' }}</h2>
      <button class="btn-close" (click)="cerrarModalPuntos()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <!-- Selecci√≥n de Jugador -->
      <div class="puntos-jugador-section">
        <h3>Selecciona el jugador:</h3>
        <div class="jugadores-puntos-grid">
          <div class="jugador-punto-card"
               *ngFor="let jugador of equipoPuntos === 'LOCAL' ? (partido?.equipo_local?.quinteto || []) : (partido?.equipo_visitante?.quinteto || [])"
               [class.selected]="jugadorPuntos?.id_jugador === jugador.id_jugador"
               (click)="seleccionarJugadorParaPuntos(jugador)">
            <div class="jugador-numero-punto">{{ jugador.dorsal }}</div>
            <div class="jugador-nombre-punto">{{ jugador.nombres }} {{ jugador.ap_p }}</div>
            <div class="jugador-stats-punto">{{ jugador.puntos }} pts</div>
          </div>
        </div>
      </div>

      <!-- Selecci√≥n de Valor -->
      <div class="puntos-valor-section" *ngIf="jugadorPuntos">
        <h3>Selecciona el valor:</h3>
        <div class="puntos-opciones">
          <button class="btn-punto-valor" (click)="registrarPuntos(1)">
            <span class="valor">{{ accionPuntos === 'SUMAR' ? '+1' : '-1' }}</span>
            <small>Tiro Libre</small>
          </button>
          <button class="btn-punto-valor" (click)="registrarPuntos(2)">
            <span class="valor">{{ accionPuntos === 'SUMAR' ? '+2' : '-2' }}</span>
            <small>Canasta</small>
          </button>
          <button class="btn-punto-valor" (click)="registrarPuntos(3)">
            <span class="valor">{{ accionPuntos === 'SUMAR' ? '+3' : '-3' }}</span>
            <small>Triple</small>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE FALTAS -->
<div class="modal-overlay" *ngIf="modalFaltasAbierto" (click)="cerrarModalFaltas()">
  <div class="modal-content-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>‚ö†Ô∏è Registrar Falta</h2>
      <button class="btn-close" (click)="cerrarModalFaltas()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="jugador-puntos-info" *ngIf="jugadorFaltas">
        <div class="jugador-numero-grande">{{ jugadorFaltas.dorsal }}</div>
        <h3>{{ getNombreCompleto(jugadorFaltas) }}</h3>
        <p class="faltas-actuales">Faltas actuales: {{ jugadorFaltas.faltas }}/5</p>
      </div>

      <p style="text-align: center; margin: 20px 0; color: #ddd;">
        ¬øConfirmar falta personal?
        <span *ngIf="jugadorFaltas && jugadorFaltas.faltas === 4" style="display: block; color: #ff3333; font-weight: 700; margin-top: 10px;">
          ‚ö†Ô∏è Esta ser√° su QUINTA falta - Ser√° EXPULSADO
        </span>
      </p>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="cerrarModalFaltas()">Cancelar</button>
        <button class="btn btn-warning" (click)="registrarFalta()">Confirmar Falta</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL EDITAR TIEMPO -->
<div class="modal-overlay" *ngIf="modalEditarTiempoAbierto" (click)="cerrarModalEditarTiempo()">
  <div class="modal-content-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>‚è±Ô∏è Editar Tiempo</h2>
      <button class="btn-close" (click)="cerrarModalEditarTiempo()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="editar-tiempo-form">
        <div class="tiempo-input-group">
          <label>Minutos</label>
          <input type="number" 
                 [(ngModel)]="minutosEditar" 
                 min="0" 
                 max="99"
                 class="tiempo-input">
        </div>
        
        <div class="tiempo-separator">:</div>
        
        <div class="tiempo-input-group">
          <label>Segundos</label>
          <input type="number" 
                 [(ngModel)]="segundosEditar" 
                 min="0" 
                 max="59"
                 class="tiempo-input">
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalEditarTiempo()">Cancelar</button>
      <button class="btn btn-primary" (click)="confirmarEditarTiempo()">Confirmar</button>
    </div>
  </div>
</div>